name: publish-npm-package

on:
  workflow_call:
    inputs:
      node_version:
        type: string
        required: false
        default: "20"
      install_command:
        type: string
        required: false
        default: "npm ci --prefer-offline"
      workdir:
        type: string
        required: false
        default: "."
      npm_scope:
        type: string
        required: true
      npm_registry:
        type: string
        required: true
    secrets:
      NODE_AUTH_TOKEN:
        required: true

jobs:
  publish:
    runs-on: ubuntu-latest
    environment: release
    defaults:
      run:
        working-directory: ${{ inputs.workdir }}

    steps:
      - name: Node setup
        uses: wesflo/gh-actions-workflows/.github/actions/_node-setup@main
        with:
          node_version: ${{ inputs.node_version }}
          workdir: ${{ inputs.workdir }}
          fetch_depth: "0"
          npm_registry: "https://npm.pkg.github.com"
          npm_scope: ${{ inputs.npm_scope }}

      - name: Determine bump from PR labels
        id: bump
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const sha = context.sha;

            const prs = await github.request('GET /repos/{owner}/{repo}/commits/{ref}/pulls', {
              owner,
              repo,
              ref: sha,
              headers: { accept: 'application/vnd.github.groot-preview+json' }
            });

            const pr = prs.data?.[0];
            const labels = (pr?.labels || []).map(l => l.name);

            let bump = 'patch';
            if (labels.includes('release:major')) bump = 'major';
            else if (labels.includes('release:minor')) bump = 'minor';
            else if (labels.includes('release:patch')) bump = 'patch';

            core.info(`PR: ${pr ? `#${pr.number}` : 'none found'}`);
            core.info(`Labels: ${labels.length ? labels.join(', ') : '(none)'}`);
            core.info(`Bump: ${bump}`);
            core.setOutput('value', bump);

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      # bump local only (no commit/tag yet)
      - name: Bump version (no commit/tag yet)
        run: |
          npm version ${{ steps.bump.outputs.value }} --no-git-tag-version

      - name: Build (lib)
        run: npm run build

      - name: Build (iife)
        run: npm run build:iife

      - name: Debug NODE_AUTH_TOKEN length
        shell: bash
        run: |
          if [ -z "${NODE_AUTH_TOKEN}" ]; then
            echo "NODE_AUTH_TOKEN is NOT set"
          else
            echo "NODE_AUTH_TOKEN length: ${#NODE_AUTH_TOKEN}"
          fi
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NODE_AUTH_TOKEN }}

      - name: Debug npm scope registry
        run: npm config get @wesflo:registry

      - name: Debug npm registry
        run: npm config get registry

      - name: Publish (GitHub Packages)
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NODE_AUTH_TOKEN }}
        run: npm publish --dry-run

      - name: Commit + tag + push (only after successful publish)
        run: |
          VERSION=$(node -p "require('./package.json').version")
          git add package.json package-lock.json
          git commit -m "chore(release): v$VERSION"
          git tag "v$VERSION"
          git push
          git push --tags

