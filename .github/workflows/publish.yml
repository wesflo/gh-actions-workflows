name: Publish npm Package

on:
  workflow_call:
    inputs:
      node_version:
        type: string
        required: false
        default: "20"
      install_cmd:
        type: string
        required: false
        default: "npm ci --prefer-offline"
      workdir:
        type: string
        required: false
        default: "."
      npm_scope:
        type: string
        required: true
      npm_registry:
        type: string
        required: true
      build_cmd:
        type: string
        required: false
        default: "npm run build"
      pack_cmd:
        type: string
        required: false
        default: "npm pack --silent"
      environment_name:
        type: string
        required: false
        default: "release"

      tarball_artifact:
        type: string
        required: false
        default: "npm-tarball"
      versionfiles_artifact:
        type: string
        required: false
        default: "npm-versionfiles"
    secrets:
      NODE_AUTH_TOKEN:
        required: true

jobs:
  publish:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment_name }}
    defaults:
      run:
        working-directory: ${{ inputs.workdir }}

    steps:
      - name: Node setup (no install needed)
        uses: wesflo/gh-actions-workflows/.github/actions/_node-setup@main
        with:
          node_version: ${{ inputs.node_version }}
          workdir: ${{ inputs.workdir }}
          fetch_depth: "0"
          npm_registry: ${{ inputs.npm_registry }}
          npm_scope: ${{ inputs.npm_scope }}

      - name: Download tarball
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.tarball_artifact }}
          path: ${{ inputs.workdir }}/.release

      - name: Download version files
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.versionfiles_artifact }}
          path: ${{ inputs.workdir }}/.release/versionfiles

      - name: Locate tarball
        id: tar
        shell: bash
        run: |
          TARBALL="$(ls -1 .release/*.tgz | head -n 1)"
          if [ -z "$TARBALL" ]; then
            echo "No .tgz found in .release"
            exit 1
          fi
          echo "path=$TARBALL" >> "$GITHUB_OUTPUT"
          echo "Using tarball: $TARBALL"

      - name: Abort if version already exists
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NODE_AUTH_TOKEN }}
        shell: bash
        run: |
          VERSION=$(node -p "require('./.release/versionfiles/package.json').version")
          PKG="${{ inputs.npm_scope }}/$(node -p "require('./.release/versionfiles/package.json').name.split('/').pop()")"
          echo "Checking registry for $PKG@$VERSION ..."
          
          if npm view "$PKG@$VERSION" version --registry "${{ inputs.npm_registry }}" >/dev/null 2>&1; then
            echo "Version already exists: $PKG@$VERSION"
            exit 1
          fi

      - name: Publish tarball (GitHub Packages)
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NODE_AUTH_TOKEN }}
        run: |
          npm publish "${{ steps.tar.outputs.path }}" --registry "${{ inputs.npm_registry }}"

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Apply bumped version files, commit + tag + push
        shell: bash
        run: |
          cp -f .release/versionfiles/package.json ./package.json
          cp -f .release/versionfiles/package-lock.json ./package-lock.json
          
          VERSION=$(node -p "require('./package.json').version")
          
          git add package.json package-lock.json
          git commit -m "chore(release): v$VERSION"
          git tag "v$VERSION"
          git push
          git push --tags
